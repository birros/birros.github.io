(window.webpackJsonp=window.webpackJsonp||[]).push([[33],{409:function(t,s,e){"use strict";e.r(s);var a=e(45),n=Object(a.a)({},(function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("p",[t._v("Petit bout de code en TypeScript montrant comment utiliser les "),e("em",[t._v("hooks")]),t._v(" d'Apollo\nGraphQL afin d'obtenir une "),e("em",[t._v("query")]),t._v(" dont les données sont mises à jour à l'aide\nd'une "),e("em",[t._v("subscription")]),t._v(". Cette astuce permet de mêler plusieurs bénéfices,\nnotamment celui de la compatibilité "),e("em",[t._v("SSR")]),t._v(" de la "),e("em",[t._v("query")]),t._v(", avec le temps réel de\nla "),e("em",[t._v("subscription")]),t._v(".")]),t._v(" "),e("h2",{attrs:{id:"le-contexte-de-l-exemple"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#le-contexte-de-l-exemple"}},[t._v("#")]),t._v(" Le contexte de l'exemple")]),t._v(" "),e("p",[t._v("L'exemple qui suit part du principe que l'on utilise "),e("a",{attrs:{href:"https://fr.wikipedia.org/wiki/TypeScript",target:"_blank",rel:"noopener noreferrer"}},[t._v("TypeScript"),e("OutboundLink")],1),t._v(" et\n"),e("a",{attrs:{href:"https://github.com/apollographql",target:"_blank",rel:"noopener noreferrer"}},[t._v("Apollo GraphQL (en)"),e("OutboundLink")],1),t._v(".")]),t._v(" "),e("p",[t._v("Pour rester simple on imagine un compteur incrémenté toutes les secondes,\naccessible au travers d'une "),e("a",{attrs:{href:"https://fr.wikipedia.org/wiki/Interface_de_programmation",target:"_blank",rel:"noopener noreferrer"}},[t._v("API"),e("OutboundLink")],1),t._v(" "),e("a",{attrs:{href:"https://fr.wikipedia.org/wiki/GraphQL",target:"_blank",rel:"noopener noreferrer"}},[t._v("GraphQL"),e("OutboundLink")],1),t._v(" ayant ce schéma :")]),t._v(" "),e("div",{staticClass:"language-graphql extra-class"},[e("pre",{pre:!0,attrs:{class:"language-graphql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Counter")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("count")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Int"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Query")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("counter")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Counter"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Subscription")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("counter")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Counter"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[e("strong",[t._v("Attention")]),t._v(" : Il est important pour pouvoir remplacer les données de la\n"),e("em",[t._v("query")]),t._v(" par celle de la "),e("em",[t._v("subscription")]),t._v(" que nom et paramètres de la "),e("em",[t._v("query")]),t._v(" et de\nla "),e("em",[t._v("subscription")]),t._v(" soient identiques, ici "),e("code",[t._v("counter")]),t._v(", ainsi que le type de données\nretourné, ici "),e("code",[t._v("Counter!")]),t._v(".")]),t._v(" "),e("h2",{attrs:{id:"le-code"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#le-code"}},[t._v("#")]),t._v(" Le code")]),t._v(" "),e("p",[t._v("La "),e("em",[t._v("query")]),t._v(" est définie dans "),e("code",[t._v("./graphql/CounterQuery.graphql")]),t._v(" :")]),t._v(" "),e("div",{staticClass:"language-graphql extra-class"},[e("pre",{pre:!0,attrs:{class:"language-graphql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("query")]),t._v(" Counter "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  counter "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    count\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[t._v("La "),e("em",[t._v("subscription")]),t._v(" est définie dans "),e("code",[t._v("./graphql/CounterSubscription.graphql")]),t._v(" :")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("subscription Counter {\n  counter {\n    count\n  }\n}\n")])])]),e("p",[t._v("Le typage des opérations GraphQL est assuré par "),e("a",{attrs:{href:"https://github.com/piglovesyou/graphql-let",target:"_blank",rel:"noopener noreferrer"}},[t._v("graphql-let (en)"),e("OutboundLink")],1),t._v(", lui-même\nbasé sur "),e("a",{attrs:{href:"https://github.com/dotansimha/graphql-code-generator",target:"_blank",rel:"noopener noreferrer"}},[t._v("GraphQL Codegen (en)"),e("OutboundLink")],1),t._v(". Le "),e("a",{attrs:{href:"https://fr.reactjs.org/docs/hooks-custom.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("hook personnalisé"),e("OutboundLink")],1),t._v(" a pour objectif de\ngarantir une exacte compatibilité avec le type de "),e("code",[t._v("useCounterQuery")]),t._v(".")]),t._v(" "),e("div",{staticClass:"language-typescript extra-class"},[e("pre",{pre:!0,attrs:{class:"language-typescript"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" useEffect "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'react'")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  useCounterQuery"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  CounterDocument"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  CounterQuery"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./graphql/CounterQuery.graphql'")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" useCounterSubscription "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./graphql/CounterSubscription.graphql'")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" useApolloClient "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@apollo/react-hooks'")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" useCounterQueryWithSubscription"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("useCounterQuery")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  baseOptions\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" client "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("useApolloClient")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" queryResult "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("useCounterQuery")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("baseOptions"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" subResult "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("useCounterSubscription")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    variables"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" baseOptions"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?.")]),t._v("variables"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    client"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" baseOptions"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?.")]),t._v("client"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    fetchPolicy"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n      baseOptions"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?.")]),t._v("fetchPolicy "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'cache-and-network'")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("undefined")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" baseOptions"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?.")]),t._v("fetchPolicy"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("useEffect")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("subResult"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("loading "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("subResult"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("error "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" subResult"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      client"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token generic-function"}},[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("writeQuery")]),e("span",{pre:!0,attrs:{class:"token generic class-name"}},[e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("CounterQuery"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")])])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        query"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" CounterDocument"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        data"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n          "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("subResult"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n          __typename"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Query'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("subResult"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("queryResult"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    loading"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" queryResult"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("loading "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" subResult"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("loading"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    error"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" queryResult"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("error "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" subResult"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("error"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    variables"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" subResult"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("variables\n      "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" subResult"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("variables\n      "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" queryResult"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("variables"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("h2",{attrs:{id:"conclusion"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#conclusion"}},[t._v("#")]),t._v(" Conclusion")]),t._v(" "),e("p",[t._v("L'avantage de ce "),e("em",[t._v("hook personnalisé")]),t._v(", en plus des bénéfices listés dans\nl'introduction ("),e("a",{attrs:{href:"https://nextjs.org/docs/basic-features/pages#server-side-rendering",target:"_blank",rel:"noopener noreferrer"}},[t._v("SSR (en)"),e("OutboundLink")],1),t._v(" et "),e("a",{attrs:{href:"https://en.wikipedia.org/wiki/Real-time_data",target:"_blank",rel:"noopener noreferrer"}},[t._v("temps réel (en)"),e("OutboundLink")],1),t._v("), est d'exposer\nl'outillage qu'offre "),e("code",[t._v("useQuery")]),t._v(" comme le "),e("a",{attrs:{href:"https://www.apollographql.com/docs/react/data/queries/#refetching",target:"_blank",rel:"noopener noreferrer"}},[t._v("refetching (en)"),e("OutboundLink")],1),t._v(" ou\nl'"),e("a",{attrs:{href:"https://www.apollographql.com/docs/react/performance/optimistic-ui/",target:"_blank",rel:"noopener noreferrer"}},[t._v("optimistic UI (en)"),e("OutboundLink")],1),t._v(".")])])}),[],!1,null,null,null);s.default=n.exports}}]);